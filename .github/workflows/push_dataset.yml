name: Generate and Push Dataset

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ parser repo checkout
      - name: Checkout parser repository
        uses: actions/checkout@v4

      # 2️⃣ Python setup
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # 4️⃣ SSH設定（Deploy Key）
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DATASET_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # 5️⃣ financial-dataset clone
      - name: Clone dataset repository
        run: |
          git clone git@github.com:yuukisabu0310/financial-dataset.git dataset

      # 6️⃣ DATASET_PATH 環境変数
      - name: Set DATASET_PATH
        run: echo "DATASET_PATH=dataset" >> $GITHUB_ENV

      # 7️⃣ パーサー実行
      - name: Run parser pipeline
        env:
          DATASET_PATH: dataset
        run: |
          python scripts/process_all.py

      # 8️⃣ dataset commit & push
      - name: Commit and Push dataset
        run: |
          cd dataset
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          # 変更が無い場合はcommitしない（エラー防止）
          if ! git diff --cached --quiet; then
            git commit -m "Auto update dataset $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "No changes to commit"
          fi
